## Bug Reference

**Severity:** Critical  
**Component:** Data Generation / Questions  
**Discovered:** December 7, 2025 - Code Review

---

## Current Behavior

There is a schema mismatch between the generated database and the example SQL question:

**Generated Schema (config.yml):**
- user_id
- question_id
- difficulty
- category
- attempt_number
- is_correct
- time_ms
- hints_used
- uses_ollama
- client

**Expected Schema (example_solution.sql):**
- employee_id
- department
- salary

---

## Expected Behavior

The database schema generated by `DataGenerator` should match the schema expected by example SQL questions, or example questions should be updated to use the actual schema.

---

## Steps to Reproduce

1. Install dependencies: `pip install pandas pyyaml`
2. Run the main script: `python SQl_answer.py`
3. Observe the error when example question tries to execute

---

## Error Details

```
Error executing SQL query: Execution failed on sql 'SELECT employee_id, department, salary
FROM searches
WHERE department = 'Sales'
ORDER BY salary DESC
LIMIT 2;': no such column: employee_id

2025-12-07 20:15:42,378 - sql_evaluation - INFO - No Active Evaluating question sql_basic_select: 
Execution failed on sql 'SELECT employee_id, department, salary
FROM searches
WHERE department = 'Sales'
ORDER BY salary DESC
LIMIT 2;': no such column: employee_id
```

---

## Affected Files

- `infra/config/config.yml` - Defines generated schema
- `Questions/sql_basic_select/example_solution.sql` - Expects employee schema
- `Questions/sql_basic_select/question` - References employee data

---

## Root Cause Analysis

The project appears to have been transitioned from an employee/HR-based example system to a SQL practice tracking system, but the example questions were not updated to match the new schema.

The config.yml generates data about **user attempts at SQL questions** (meta-data about the platform itself), while the example question expects **employee data** (sample data for practicing SQL).

---

## Proposed Fix

**Option 1: Update Example Question to Use Actual Schema (Quick Fix)**

Update `Questions/sql_basic_select/example_solution.sql`:
```sql
-- Before
SELECT employee_id, department, salary
FROM searches
WHERE department = 'Sales'
ORDER BY salary DESC
LIMIT 2;

-- After
SELECT user_id, category, time_ms
FROM searches
WHERE difficulty = 'BEGINNER'
ORDER BY time_ms ASC
LIMIT 10;
```

Update `Questions/sql_basic_select/question`:
```
SQL Basic SELECT Challenge

Write a SQL query to:
1. Select all attempts from BEGINNER difficulty
2. Order the results by time taken (ascending - fastest first)
3. Limit the result to the top 10 attempts

Expected output columns:
- user_id
- category
- time_ms
```

**Option 2: Update Schema to Match Example (Better Long-term)**

This aligns with PRODUCT_ROADMAP.md TASK-003. Create a proper employee schema:

Update `infra/config/config.yml` to generate employee data:
```yaml
data_generation:
  num_records: 100
  seed: 42
  table_name: employees

fields:
  - name: employee_id
    type: int
    values:
      min: 1
      max: 1000

  - name: first_name
    type: str
    values: [John, Jane, Alice, Bob, Charlie, Diana, Eve, Frank, Grace, Henry]

  - name: last_name
    type: str
    values: [Smith, Johnson, Williams, Brown, Jones, Garcia, Miller, Davis, Rodriguez, Martinez]

  - name: department
    type: str
    values: [Sales, Engineering, HR, Marketing, Finance, Operations]

  - name: salary
    type: int
    values:
      min: 40000
      max: 150000

  - name: hire_date
    type: str
    values: ["2020-01-15", "2021-03-22", "2019-11-10", "2022-05-30", "2020-09-14"]
```

**Option 3: Support Multiple Schemas (Best)**

Modify DataGenerator to support multiple table generation and create both:
1. `employees` table - for practicing SQL queries
2. `attempts` table - for tracking user progress

---

## Acceptance Criteria

- [ ] Example SQL queries execute successfully
- [ ] Generated database schema matches question expectations
- [ ] No SQL execution errors when running SQl_answer.py
- [ ] Solution CSV matches query output
- [ ] Documentation updated to reflect schema
- [ ] All tests pass

---

## AI Agent Instructions

1. **Choose an approach:**
   - Recommend Option 3 (multiple schemas) for best long-term solution
   - Can implement Option 1 as quick fix first, then Option 3

2. **If implementing Option 1 (Quick Fix):**
   - Update `Questions/sql_basic_select/example_solution.sql`
   - Update `Questions/sql_basic_select/question`
   - Regenerate `Questions/sql_basic_select/solutions/solution_df.csv`
   - Test that query executes successfully

3. **If implementing Option 2 or 3 (Proper Fix):**
   - Review PRODUCT_ROADMAP.md TASK-003 for multi-table schema design
   - Update or create new config file for employee schema
   - Modify DataGenerator to support multiple table generation
   - Create SchemaGenerator for proper relational schema
   - Update example questions to use new schema
   - Create seed data generation

4. **Test the fix:**
   ```bash
   # Generate data
   python -m infra.DataGenerator
   
   # Run main script
   python SQl_answer.py
   
   # Should complete without SQL errors
   ```

5. **Update documentation:**
   - Document the schema in README.md
   - Add schema diagram if implementing multi-table
   - Update example question documentation

---

## Test Verification

```bash
# Clean slate
rm -f output/generated_data.db output/generated_data.csv

# Generate new data with fixed schema
python -m infra.DataGenerator

# Verify table structure
sqlite3 output/generated_data.db "PRAGMA table_info(searches);"
# or
sqlite3 output/generated_data.db "PRAGMA table_info(employees);"

# Run example query manually
sqlite3 output/generated_data.db < Questions/sql_basic_select/example_solution.sql

# Run full validation
python SQl_answer.py

# Should see: "Solution is correct!" without errors
```

---

## Notes

- This is a blocking issue for the core functionality
- The fix impacts question design philosophy:
  - **Meta-schema**: Questions about the platform's own data
  - **Practice-schema**: Separate HR/business data for SQL practice
- Recommend implementing proper multi-table schema per TASK-003
- This will enable more realistic JOIN, GROUP BY, and subquery questions

---

## Related Issues

- TASK-003 in PRODUCT_ROADMAP.md: Database Schema Enhancement
- ISSUE-007: Need to validate SQL queries don't have injection vulnerabilities
- Future: Need more example questions with proper schema

---

## Sample Multi-Schema Config (Recommended)

```yaml
# infra/config/schemas.yml
schemas:
  employees:
    table_name: employees
    num_records: 100
    fields:
      - name: employee_id
        type: int
        primary_key: true
      - name: department
        type: str
        values: [Sales, Engineering, HR, Marketing]
      - name: salary
        type: int
        values: {min: 40000, max: 150000}
  
  attempts:
    table_name: attempts
    num_records: 10000
    fields:
      - name: user_id
        type: int
      - name: difficulty
        type: str
        values: [BEGINNER, INTERMEDIATE, ADVANCED, EXPERT]
      - name: time_ms
        type: int
        values: {min: 500, max: 600000}
```
